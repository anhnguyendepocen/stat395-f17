---
title: "Class 05: Up in the Air (with Matrices!)"
author: "Taylor Arnold"
output: html_notebook
---




{% highlight r %}
library(readr)
library(ggplot2)
library(dplyr)
{% endhighlight %}


## Matrices in R


{% highlight r %}
A <- matrix(sample(1:99, 25), 5, 5)
A
{% endhighlight %}



{% highlight text %}
##      [,1] [,2] [,3] [,4] [,5]
## [1,]   10   35    7   74   12
## [2,]   36   25   13   44   57
## [3,]   33   80   18   16   34
## [4,]   53   64   70   30   63
## [5,]   37   55   59   27   99
{% endhighlight %}



{% highlight r %}
b <- matrix(sample(1:99, 5))
b
{% endhighlight %}



{% highlight text %}
##      [,1]
## [1,]   53
## [2,]   12
## [3,]   22
## [4,]   51
## [5,]   82
{% endhighlight %}

Element-wise arithmetic is assumed by default:


{% highlight r %}
A + A
{% endhighlight %}



{% highlight text %}
##      [,1] [,2] [,3] [,4] [,5]
## [1,]   20   70   14  148   24
## [2,]   72   50   26   88  114
## [3,]   66  160   36   32   68
## [4,]  106  128  140   60  126
## [5,]   74  110  118   54  198
{% endhighlight %}

Matrix products require you to use `%*%`:


{% highlight r %}
A %*% A
{% endhighlight %}



{% highlight text %}
##      [,1]  [,2] [,3]  [,4]  [,5]
## [1,] 5957  7181 6539  4936  8203
## [2,] 6130  8876 7254  6831 10714
## [3,] 5910  7489 4721  7648  9942
## [4,] 9065 14440 8280 10459 14791
## [5,] 9391 14563 9767  9585 17087
{% endhighlight %}


{% highlight r %}
A %*% b
{% endhighlight %}



{% highlight text %}
##       [,1]
## [1,]  5862
## [2,]  9412
## [3,]  6709
## [4,] 11813
## [5,] 13414
{% endhighlight %}


{% highlight r %}
A[2:3, 1:2]
{% endhighlight %}



{% highlight text %}
##      [,1] [,2]
## [1,]   36   25
## [2,]   33   80
{% endhighlight %}


{% highlight r %}
A[,1:2]
{% endhighlight %}



{% highlight text %}
##      [,1] [,2]
## [1,]   10   35
## [2,]   36   25
## [3,]   33   80
## [4,]   53   64
## [5,]   37   55
{% endhighlight %}


{% highlight r %}
A[,1]
{% endhighlight %}



{% highlight text %}
## [1] 10 36 33 53 37
{% endhighlight %}


{% highlight r %}
A[,1][1]
{% endhighlight %}



{% highlight text %}
## [1] 10
{% endhighlight %}


{% highlight r %}
A[1:5 > 3,]
{% endhighlight %}



{% highlight text %}
##      [,1] [,2] [,3] [,4] [,5]
## [1,]   53   64   70   30   63
## [2,]   37   55   59   27   99
{% endhighlight %}

## Matrix Formulation of Linear Models

The multivariate linear regression model is, on the surface,
only a slight generalization of the simple linear regression model:

$$y_i = x_{1,i} \beta_1 + x_{2,i} \beta_2 + \cdots + x_{1,p} \beta_p + \epsilon_i$$

The statistical estimation problem now becomes one of estimating the $p$
components of the multivariate vector $\beta$.

A sample can be re-written in terms of the vector $x_i$
(the vector of covariates for a single observation):

$$y_i = x_{i}^t \beta + \epsilon_i$$

In matrix notation, we can write the linear model simultaneously
for all observations:

$$ \left(\begin{array}{c}y_1\\ y_2\\ \vdots\\ y_n\end{array}\right) =
  \left(\begin{array}{cccc}x_{1,1}&x_{2,1}&\cdots&x_{p,1}\\
                           x_{1,2}&\ddots&&x_{p,2}\\
                           \vdots&&\ddots&\vdots\\
                           x_{1,n}&x_{2,n}&\cdots&x_{p,n}\\\end{array}\right)
  \left(\begin{array}{c}\beta_1\\ \beta_2\\ \vdots\\ \beta_p\end{array}\right) +
  \left(\begin{array}{c}\epsilon_1\\ \epsilon_2\\ \vdots\\ \epsilon_n\end{array}\right) $$


Which can be compactly written as:

$$ y = X \beta + \epsilon $$

For reference, note the following equation yields these dimensions:

$$ y \in \mathbb{R}^n $$
$$ X \in \mathbb{R}^{n \times p} $$
$$ \beta \in \mathbb{R}^p $$
$$ \epsilon \in \mathbb{R}^n $$

## Linear Models with Matrices in R


{% highlight r %}
flights <- read_csv("~/files/ml_data/flights_15min.csv")
{% endhighlight %}


{% highlight r %}
y <- flights$delayed

X <- as.matrix(select(flights, arr_hour, dep_hour))
X[1:10,]
{% endhighlight %}



{% highlight text %}
##       arr_hour dep_hour
##  [1,]       22       21
##  [2,]       13       11
##  [3,]       22       21
##  [4,]       22       20
##  [5,]       14       12
##  [6,]       16        8
##  [7,]       21       15
##  [8,]       19       17
##  [9,]       12        9
## [10,]       12       11
{% endhighlight %}


{% highlight r %}
X_train <- X[flights$train_id == "train", ]
X_valid <- X[flights$train_id == "valid", ]
y_train <- y[flights$train_id == "train"]
y_valid <- y[flights$train_id == "valid"]
{% endhighlight %}


{% highlight r %}
lm.fit(X_train, y_train)$coef
{% endhighlight %}



{% highlight text %}
##  arr_hour  dep_hour 
## 0.0522682 0.0531534
{% endhighlight %}


{% highlight r %}
beta <- lm.fit(cbind(1, X_train), y_train)$coef
beta
{% endhighlight %}



{% highlight text %}
##              arr_hour   dep_hour 
## 0.20905417 0.04406644 0.04824098
{% endhighlight %}


{% highlight r %}
beta <- lm.fit(cbind(1, X_train), y_train)$coef
sqrt( mean( (cbind(1, X_valid) %*% beta - y_valid)^2))
{% endhighlight %}



{% highlight text %}
## [1] 2.415901
{% endhighlight %}


{% highlight r %}
X <- model.matrix(~ carrier , data = flights[,-c(1:3)])
y <- flights$delayed

head(X)
{% endhighlight %}



{% highlight text %}
##   (Intercept) carrierAA carrierAQ carrierAS carrierB6 carrierCO carrierDL
## 1           1         0         0         0         0         0         0
## 2           1         0         0         0         0         0         0
## 3           1         0         0         0         0         0         0
## 4           1         0         0         0         0         0         0
## 5           1         0         0         0         0         0         0
## 6           1         0         0         0         1         0         0
##   carrierEV carrierF9 carrierFL carrierHA carrierMQ carrierNW carrierOH
## 1         0         0         0         0         0         0         0
## 2         1         0         0         0         0         0         0
## 3         0         0         0         0         0         1         0
## 4         0         0         0         0         0         0         0
## 5         0         0         0         0         0         0         0
## 6         0         0         0         0         0         0         0
##   carrierOO carrierUA carrierUS carrierWN carrierXE carrierYV
## 1         0         0         0         0         0         1
## 2         0         0         0         0         0         0
## 3         0         0         0         0         0         0
## 4         0         0         0         1         0         0
## 5         0         0         1         0         0         0
## 6         0         0         0         0         0         0
{% endhighlight %}


{% highlight r %}
head(flights$carrier)
{% endhighlight %}



{% highlight text %}
## [1] "YV" "EV" "NW" "WN" "US" "B6"
{% endhighlight %}


{% highlight r %}
y_train <- y[flights$train_id == "train"]
y_valid <- y[flights$train_id == "valid"]
X_train <- X[flights$train_id == "train",]
X_valid <- X[flights$train_id == "valid",]
{% endhighlight %}


{% highlight r %}
beta <- lm.fit(X_train, y_train)$coef
beta
{% endhighlight %}



{% highlight text %}
## (Intercept)   carrierAA   carrierAQ   carrierAS   carrierB6   carrierCO 
##  1.45336226  0.45833410 -0.99573514  0.19141386  0.30913774  0.27300590 
##   carrierDL   carrierEV   carrierF9   carrierFL   carrierHA   carrierMQ 
## -0.19697928  0.91240956 -0.68686479 -0.02243442 -0.94686875  0.45032046 
##   carrierNW   carrierOH   carrierOO   carrierUA   carrierUS   carrierWN 
## -0.20260083  0.30558313 -0.13428070  0.19623614  0.06097466 -0.39594176 
##   carrierXE   carrierYV 
##  0.52541758  0.23031121
{% endhighlight %}


{% highlight r %}
pred <- X %*% beta
length(pred)
{% endhighlight %}



{% highlight text %}
## [1] 25000
{% endhighlight %}



{% highlight r %}
dim(flights)
{% endhighlight %}



{% highlight text %}
## [1] 25000    12
{% endhighlight %}


{% highlight r %}
flights$delayed_pred <- pred
{% endhighlight %}

## Sparse Matricies


{% highlight r %}
library(methods)
library(MatrixModels)
X <- model.Matrix(~ carrier , data = flights[,-c(1:3)], sparse = TRUE)
X[1:10,]
{% endhighlight %}



{% highlight text %}
## 10 x 20 sparse Matrix of class "dgCMatrix"
{% endhighlight %}



{% highlight text %}
##    [[ suppressing 20 column names '(Intercept)', 'carrierAA', 'carrierAQ' ... ]]
{% endhighlight %}



{% highlight text %}
##                                           
## 1  1 . . . . . . . . . . . . . . . . . . 1
## 2  1 . . . . . . 1 . . . . . . . . . . . .
## 3  1 . . . . . . . . . . . 1 . . . . . . .
## 4  1 . . . . . . . . . . . . . . . . 1 . .
## 5  1 . . . . . . . . . . . . . . . 1 . . .
## 6  1 . . . 1 . . . . . . . . . . . . . . .
## 7  1 . . . . . . . . . . . . . . 1 . . . .
## 8  1 . . . . . . . . . . . 1 . . . . . . .
## 9  1 . . . . . . . . . . . . . . 1 . . . .
## 10 1 . . . . . . . . . . . 1 . . . . . . .
{% endhighlight %}


{% highlight r %}
X_train <- X[flights$train_id == "train",]
X_valid <- X[flights$train_id == "valid",]
{% endhighlight %}


{% highlight r %}
beta <- MatrixModels:::lm.fit.sparse(X_train, y_train)
beta
{% endhighlight %}



{% highlight text %}
##  [1]  1.45336226  0.45833410 -0.99573514  0.19141386  0.30913774
##  [6]  0.27300590 -0.19697928  0.91240956 -0.68686479 -0.02243442
## [11] -0.94686875  0.45032046 -0.20260083  0.30558313 -0.13428070
## [16]  0.19623614  0.06097466 -0.39594176  0.52541758  0.23031121
{% endhighlight %}



{% highlight r %}
library(forcats)
model <- lm(delayed ~ fct_lump(carrier, 4), data = flights)
model
{% endhighlight %}



{% highlight text %}
## 
## Call:
## lm(formula = delayed ~ fct_lump(carrier, 4), data = flights)
## 
## Coefficients:
##               (Intercept)     fct_lump(carrier, 4)OO  
##                    1.9002                    -0.6264  
##    fct_lump(carrier, 4)US     fct_lump(carrier, 4)WN  
##                   -0.4480                    -0.8362  
## fct_lump(carrier, 4)Other  
##                   -0.2838
{% endhighlight %}





