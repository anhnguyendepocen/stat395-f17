---
title: "Class 13: Congratulations, You've Won $1M!"
author: "Taylor Arnold"
output: html_notebook
---





{% highlight r %}
library(readr)
library(dplyr)
library(ggplot2)

# text processing packages
library(tokenizers)
library(stringi)
library(smodels)
{% endhighlight %}


{% highlight r %}
spam <- read_csv("~/files/ml_data/spam.csv")
{% endhighlight %}


{% highlight r %}
stri_wrap(spam$text[500], width = 60)
{% endhighlight %}



{% highlight text %}
## [1] "Orange brings you ringtones from all time Chart Heroes, with"
## [2] "a free hit each week! Go to Ringtones & Pics on wap. To stop"
## [3] "receiving these tips reply STOP."
{% endhighlight %}


{% highlight r %}
token_list <- tokenize_words(spam$text)
token_list[500]
{% endhighlight %}



{% highlight text %}
## [[1]]
##  [1] "orange"    "brings"    "you"       "ringtones" "from"     
##  [6] "all"       "time"      "chart"     "heroes"    "with"     
## [11] "a"         "free"      "hit"       "each"      "week"     
## [16] "go"        "to"        "ringtones" "pics"      "on"       
## [21] "wap"       "to"        "stop"      "receiving" "these"    
## [26] "tips"      "reply"     "stop"
{% endhighlight %}


{% highlight r %}
token_df <- term_list_to_df(token_list)
{% endhighlight %}



{% highlight text %}
## Loading required package: methods
{% endhighlight %}



{% highlight text %}
## Loading required package: Matrix
{% endhighlight %}



{% highlight r %}
filter(token_df, id == 500)
{% endhighlight %}



{% highlight text %}
## # A tibble: 28 x 2
##       id     token
##    <int>     <chr>
##  1   500    orange
##  2   500    brings
##  3   500       you
##  4   500 ringtones
##  5   500      from
##  6   500       all
##  7   500      time
##  8   500     chart
##  9   500    heroes
## 10   500      with
## # ... with 18 more rows
{% endhighlight %}


{% highlight r %}
X <- term_df_to_matrix(token_df)
dim(X)
{% endhighlight %}



{% highlight text %}
## [1] 1276 4454
{% endhighlight %}


{% highlight r %}
colnames(X)[1:10]
{% endhighlight %}



{% highlight text %}
##  [1] "to"   "you"  "a"    "i"    "call" "the"  "u"    "your" "for"  "is"
{% endhighlight %}



{% highlight r %}
X[1:10,1:10]
{% endhighlight %}



{% highlight text %}
## 10 x 10 sparse Matrix of class "dgTMatrix"
{% endhighlight %}



{% highlight text %}
##    [[ suppressing 10 column names 'to', 'you', 'a' ... ]]
{% endhighlight %}



{% highlight text %}
##                          
##  [1,] 1 . 2 . . 1 . . . .
##  [2,] 2 . . . . . . . . .
##  [3,] . . . 1 1 . . 1 1 .
##  [4,] . 1 . . . . . . . .
##  [5,] . . . . . . 1 . 1 .
##  [6,] 1 1 . . . . . 2 . .
##  [7,] 3 2 2 . 1 . . 1 . .
##  [8,] . . . . . 1 1 . . .
##  [9,] 3 1 . . . 1 1 . 1 .
## [10,] 1 . . . . . . . . .
{% endhighlight %}


{% highlight r %}
X_train <- X[spam$train_id == "train",]
X_valid <- X[spam$train_id == "valid",]
y_train <- spam$class[spam$train_id == "train"]
y_valid <- spam$class[spam$train_id == "valid"]
{% endhighlight %}


{% highlight r %}
library(glmnet)
model <- cv.glmnet(X_train, y_train)
plot(model)
{% endhighlight %}

![plot of chunk unnamed-chunk-9](../assets/2017-10-10-class13/unnamed-chunk-9-1.png)


{% highlight r %}
beta <- coef(model, s = model$lambda.min)
rownames(beta)[which((beta != 0))]
{% endhighlight %}



{% highlight text %}
##   [1] "(Intercept)"                 "to"                         
##   [3] "a"                           "i"                          
##   [5] "call"                        "your"                       
##   [7] "for"                         "now"                        
##   [9] "2"                           "free"                       
##  [11] "or"                          "ur"                         
##  [13] "txt"                         "from"                       
##  [15] "my"                          "4"                          
##  [17] "me"                          "text"                       
##  [19] "mobile"                      "stop"                       
##  [21] "not"                         "reply"                      
##  [23] "only"                        "prize"                      
##  [25] "that"                        "do"                         
##  [27] "we"                          "out"                        
##  [29] "at"                          "cash"                       
##  [31] "but"                         "won"                        
##  [33] "new"                         "send"                       
##  [35] "i'm"                         "gt"                         
##  [37] "please"                      "1"                          
##  [39] "150p"                        "lt"                         
##  [41] "up"                          "win"                        
##  [43] "urgent"                      "week"                       
##  [45] "contact"                     "msg"                        
##  [47] "service"                     "when"                       
##  [49] "who"                         "ok"                         
##  [51] "18"                          "chat"                       
##  [53] "customer"                    "how"                        
##  [55] "come"                        "cs"                         
##  [57] "its"                         "500"                        
##  [59] "draw"                        "more"                       
##  [61] "message"                     "awarded"                    
##  [63] "100"                         "find"                       
##  [65] "1.50"                        "line"                       
##  [67] "receive"                     "code"                       
##  [69] "ringtone"                    "still"                      
##  [71] "he"                          "mob"                        
##  [73] "da"                          "hope"                       
##  [75] "i'll"                        "tones"                      
##  [77] "8007"                        "again"                      
##  [79] "where"                       "account"                    
##  [81] "orange"                      "sexy"                       
##  [83] "top"                         "10"                         
##  [85] "250"                         "much"                       
##  [87] "5"                           "expires"                    
##  [89] "games"                       "later"                      
##  [91] "calls"                       "ham"                        
##  [93] "join"                        "oh"                         
##  [95] "uk"                          "winner"                     
##  [97] "http"                        "unsubscribe"                
##  [99] "something"                   "voucher"                    
## [101] "amp"                         "content"                    
## [103] "days"                        "hot"                        
## [105] "m"                           "pics"                       
## [107] "player"                      "choose"                     
## [109] "eg"                          "info"                       
## [111] "told"                        "txts"                       
## [113] "wap"                         "welcome"                    
## [115] "call2optout"                 "charge"                     
## [117] "problem"                     "terms"                      
## [119] "thing"                       "admirer"                    
## [121] "called"                      "ldn"                        
## [123] "sunshine"                    "within"                     
## [125] "50"                          "always"                     
## [127] "co.uk"                       "crazy"                      
## [129] "few"                         "goto"                       
## [131] "i've"                        "member"                     
## [133] "saturday"                    "sure"                       
## [135] "address"                     "entered"                    
## [137] "questions"                   "xx"                         
## [139] "80488"                       "announcement"               
## [141] "conditions"                  "enough"                     
## [143] "frnd"                        "glad"                       
## [145] "local"                       "luck"                       
## [147] "spam"                        "sport"                      
## [149] "2day"                        "62468"                      
## [151] "alone"                       "email"                      
## [153] "gettin"                      "hav"                        
## [155] "inviting"                    "selection"                  
## [157] "team"                        "2005"                       
## [159] "4u"                          "88066"                      
## [161] "amazing"                     "asks"                       
## [163] "bank"                        "bill"                       
## [165] "boytoy"                      "cam"                        
## [167] "costs"                       "e.g"                        
## [169] "fri"                         "hint"                       
## [171] "members"                     "minmobsmorelkpobox177hp51fl"
## [173] "purchase"                    "registered"                 
## [175] "save"                        "seemed"                     
## [177] "some1"                       "strong"                     
## [179] "super"                       "term"                       
## [181] "tickets"                     "02073162414"                
## [183] "12mths"                      "2u"                         
## [185] "30"                          "3d"                         
## [187] "447797706009"                "5.00"                       
## [189] "ago"                         "ain't"                      
## [191] "bloomberg"                   "bloomberg.com"              
## [193] "costing"                     "darling"                    
## [195] "explicit"                    "explosive"                  
## [197] "further"                     "gender"                     
## [199] "granite"                     "hoping"                     
## [201] "ice"                         "issues"                     
## [203] "lookatme"                    "nasdaq"                     
## [205] "secs"                        "sptv"                       
## [207] "star"                        "symbol"                     
## [209] "technical"                   "unique"                     
## [211] "web"                         "07880867867"                
## [213] "07946746291"                 "08450542832"                
## [215] "0871750.77.11"               "08718726270"                
## [217] "1,000"                       "146tf150p"                  
## [219] "151"                         "24m"                        
## [221] "32323"                       "35p"                        
## [223] "391784"                      "400mins"                    
## [225] "84122"                       "84484"                      
## [227] "adrian"                      "amy"                        
## [229] "appreciate"                  "banned"                     
## [231] "barbie"                      "breath"                     
## [233] "call09050000327"             "channel"                    
## [235] "clip"                        "clubsaisai"                 
## [237] "cnn"                         "coincidence"                
## [239] "confirmd"                    "couple"                     
## [241] "created"                     "current"                    
## [243] "dating:i"                    "detroit"                    
## [245] "devils"                      "divorce"                    
## [247] "experience"                  "fgkslpo"                    
## [249] "fgkslpopw"                   "hockey"                     
## [251] "housewives"                  "ibn"                        
## [253] "incorrect"                   "itz"                        
## [255] "iz"                          "j5q"                        
## [257] "jersey"                      "ken's"                      
## [259] "landlines"                   "leading"                    
## [261] "marketing"                   "mmsto"                      
## [263] "mobsi.com"                   "monthly"                    
## [265] "nearly"                      "notified"                   
## [267] "offering"                    "opinions"                   
## [269] "outgoing"                    "paris.free"                 
## [271] "parties"                     "pause"                      
## [273] "pg"                          "presence"                   
## [275] "rct"                         "recieve"                    
## [277] "rgds"                        "ringtoneking"               
## [279] "romcapspam"                  "roses"                      
## [281] "sending"                     "sms.shsex.netun"            
## [283] "soiree"                      "speciale"                   
## [285] "teletext"                    "thankyou"                   
## [287] "thnq"                        "update_now"                 
## [289] "vatian"                      "videos"                     
## [291] "wings"                       "wrote"                      
## [293] "www.asjesus.com"             "xclusive"                   
## [295] "zouk"
{% endhighlight %}


{% highlight r %}
beta <- coef(model, s = model$lambda.1se)
paste(rownames(beta)[which((beta != 0))], " (",
      sign(beta)[which((beta != 0))], ")", sep = "")
{% endhighlight %}



{% highlight text %}
##  [1] "(Intercept) (1)"                 "to (1)"                         
##  [3] "a (1)"                           "i (-1)"                         
##  [5] "call (1)"                        "your (1)"                       
##  [7] "for (1)"                         "now (1)"                        
##  [9] "2 (1)"                           "free (1)"                       
## [11] "or (1)"                          "txt (1)"                        
## [13] "from (1)"                        "me (-1)"                        
## [15] "text (1)"                        "mobile (1)"                     
## [17] "stop (1)"                        "not (-1)"                       
## [19] "reply (1)"                       "prize (1)"                      
## [21] "do (-1)"                         "cash (1)"                       
## [23] "but (-1)"                        "won (1)"                        
## [25] "new (1)"                         "send (1)"                       
## [27] "i'm (-1)"                        "gt (-1)"                        
## [29] "please (1)"                      "1 (1)"                          
## [31] "150p (1)"                        "lt (-1)"                        
## [33] "win (1)"                         "urgent (1)"                     
## [35] "contact (1)"                     "msg (1)"                        
## [37] "service (1)"                     "18 (1)"                         
## [39] "come (-1)"                       "cs (1)"                         
## [41] "500 (1)"                         "more (1)"                       
## [43] "awarded (1)"                     "100 (1)"                        
## [45] "find (1)"                        "1.50 (1)"                       
## [47] "code (1)"                        "ringtone (1)"                   
## [49] "he (-1)"                         "mob (1)"                        
## [51] "da (-1)"                         "hope (-1)"                      
## [53] "i'll (-1)"                       "again (-1)"                     
## [55] "them (-1)"                       "account (1)"                    
## [57] "sexy (1)"                        "top (1)"                        
## [59] "much (-1)"                       "5 (1)"                          
## [61] "games (1)"                       "later (-1)"                     
## [63] "calls (1)"                       "winner (1)"                     
## [65] "http (1)"                        "unsubscribe (1)"                
## [67] "voucher (1)"                     "days (1)"                       
## [69] "pics (1)"                        "choose (1)"                     
## [71] "wap (1)"                         "called (-1)"                    
## [73] "sunshine (1)"                    "co.uk (1)"                      
## [75] "goto (1)"                        "sure (-1)"                      
## [77] "alone (1)"                       "email (-1)"                     
## [79] "88066 (1)"                       "asks (-1)"                      
## [81] "bank (1)"                        "bill (1)"                       
## [83] "costs (1)"                       "members (1)"                    
## [85] "minmobsmorelkpobox177hp51fl (1)" "strong (1)"                     
## [87] "02073162414 (1)"                 "30 (1)"                         
## [89] "5.00 (1)"                        "cdgt (1)"                       
## [91] "explicit (1)"                    "explosive (1)"                  
## [93] "further (1)"                     "granite (1)"                    
## [95] "issues (1)"                      "nasdaq (1)"                     
## [97] "secs (1)"                        "symbol (1)"
{% endhighlight %}


{% highlight r %}
y_valid_pred <- as.numeric(predict(model, X_valid, type = "response") > 0.5)
mean(y_valid == y_valid_pred)
{% endhighlight %}



{% highlight text %}
## [1] 0.9333333
{% endhighlight %}

## Modify the features


{% highlight r %}
X <- term_df_to_matrix(token_df, min_df = 0.03)
y <- spam$class
X_train <- X[spam$train_id == "train",]
X_valid <- X[spam$train_id == "valid",]
y_train <- spam$class[spam$train_id == "train"]
y_valid <- spam$class[spam$train_id == "valid"]

model <- cv.glmnet(X_train, y_train)
plot(model)
{% endhighlight %}

![plot of chunk unnamed-chunk-13](../assets/2017-10-10-class13/unnamed-chunk-13-1.png)


{% highlight r %}
beta <- coef(model, s = model$lambda.1se)
paste(rownames(beta)[which((beta != 0))], " (",
      sign(beta)[which((beta != 0))], ")", sep = "")
{% endhighlight %}



{% highlight text %}
##  [1] "(Intercept) (1)" "to (1)"          "a (1)"          
##  [4] "i (-1)"          "call (1)"        "your (1)"       
##  [7] "for (1)"         "now (1)"         "2 (1)"          
## [10] "free (1)"        "or (1)"          "txt (1)"        
## [13] "from (1)"        "4 (1)"           "me (-1)"        
## [16] "text (1)"        "mobile (1)"      "stop (1)"       
## [19] "not (-1)"        "reply (1)"       "prize (1)"      
## [22] "do (-1)"         "cash (1)"        "but (-1)"       
## [25] "won (1)"         "new (1)"         "send (1)"       
## [28] "i'm (-1)"        "please (1)"      "1 (1)"          
## [31] "150p (1)"        "win (1)"         "contact (1)"    
## [34] "msg (1)"         "service (1)"     "18 (1)"
{% endhighlight %}


{% highlight r %}
y_valid_pred <- as.numeric(predict(model, X_valid, type = "response") > 0.5)
mean(y_valid == y_valid_pred)
{% endhighlight %}



{% highlight text %}
## [1] 0.9215686
{% endhighlight %}

## Negative examples


{% highlight r %}
table(y_valid = y_valid, y_valid_pred = y_valid_pred)
{% endhighlight %}



{% highlight text %}
##        y_valid_pred
## y_valid   0   1
##       0 131   4
##       1  16 104
{% endhighlight %}


{% highlight r %}
y_pred <- as.numeric(predict(model, X, type = "response") > 0.5)
these_rows <- which(spam$train_id == "valid" &
                    y != y_pred &
                    y == 1)
cat(stri_wrap(spam$text[these_rows], exdent = 5), sep = "\n")
{% endhighlight %}



{% highlight text %}
## Cashbin.co.uk (Get lots of cash this weekend!) www.cashbin.co.uk
##      Dear Welcome to the weekend We have got our biggest and best EVER
##      cash give away!! These..
## Do you ever notice that when you're driving, anyone going slower
##      than you is an idiot and everyone driving faster than you is a
##      maniac?
## http//tms. widelive.com/index. wml?
##      id=820554ad0a1705572711&first=true¡C C Ringtone¡
## network operator. The service is free. For T & C's visit 80488.biz
## PRIVATE! Your 2003 Account Statement for 078
## Filthy stories and GIRLS waiting for your
## Get 3 Lions England tone, reply lionm 4 mono or lionp 4 poly. 4
##      more go 2 www.ringtones.co.uk, the original n best. Tones 3GBP
##      network operator rates apply
## Ringtone Club: Gr8 new polys direct to your mobile every week !
## Warner Village 83118 C Colin Farrell in SWAT this wkend @Warner
##      Village & get 1 free med. Popcorn!Just show msg+ticket@kiosk.Valid
##      4-7/12. C t&c @kiosk. Reply SONY 4 mre film offers
## Reminder: You have not downloaded the content you have already paid
##      for. Goto http://doit. mymoby. tv/ to collect your content.
## New Tones This week include: 1)McFly-All Ab.., 2) Sara Jorge-
##      Shock.. 3) Will Smith-Switch.. To order follow instructions on next
##      message
## Latest News! Police station toilet stolen, cops have nothing to go
##      on!
## Money i have won wining number 946 wot do i do next
## You will be receiving this week's Triple Echo ringtone shortly.
##      Enjoy it!
## Am new 2 club & dont fink we met yet Will B gr8 2 C U Please leave
##      msg 2day wiv ur area 09099726553 reply promised CARLIE x Calls£1/
##      minMobsmore LKPOBOX177HP51FL
## SplashMobile: Choose from 1000s of gr8 tones each wk! This is a
##      subscrition service with weekly tones costing 300p. U have one
##      credit - kick back and ENJOY
{% endhighlight %}


{% highlight r %}
y_pred <- as.numeric(predict(model, X, type = "response") > 0.5)
these_rows <- which(spam$train_id == "valid" &
                    y != y_pred &
                    y == 0)
cat(stri_wrap(spam$text[these_rows], exdent = 5), sep = "\n")
{% endhighlight %}



{% highlight text %}
## if you text on your way to cup stop that should work. And that
##      should be BUS
## We have sent JD for Customer Service cum Accounts Executive to ur
##      mail id, For details contact us
## I‘ll have a look at the frying pan in case it‘s cheap or a book
##      perhaps. No that‘s silly a frying pan isn‘t likely to be a book
## In e msg jus now. U said thanks for gift.
{% endhighlight %}

## Visualization


{% highlight r %}
library(irlba)
X_pca <- prcomp_irlba(X_train, n = 2)$x
qplot(X_pca[,1], X_pca[,2], color = factor(y_train),
      alpha = I(0.3)) +
  viridis::scale_color_viridis(discrete = TRUE) +
  theme_minimal()
{% endhighlight %}

![plot of chunk unnamed-chunk-19](../assets/2017-10-10-class13/unnamed-chunk-19-1.png)




