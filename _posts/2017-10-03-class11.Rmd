---
title: "Class 11: Corn Belt Housing"
author: "Taylor Arnold"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = TRUE)
knitr::opts_chunk$set(fig.path = "../assets/2017-10-03-class11/")
```

```{r, message = FALSE}
library(readr)
library(ggplot2)
library(dplyr)
```

```{r, message = FALSE}
ames <- read_csv("~/files/ml_data/ames.csv")
```

## Decision Trees

```{r}
library(tree)
model <- tree(saleprice ~ neighborhood + overall_qual + overall_cond + year_built,
                      data = ames, subset = train_id == "train",
              control = tree.control(nobs = nrow(ames), mindev = 0.005))
```


```{r}
par(mar = c(0,0,0,0))
plot(model, type = "uniform")
text(model, cex = 0.7, col = "purple")
```

## Random Forests

```{r, message = FALSE}
library(randomForest)
model <- randomForest(saleprice ~ overall_qual + year_built,
                      data = ames, subset = train_id == "train",
                      ntree = 20, maxnodes = 3, mtry = 1)
```

```{r}
obj <- predict(model, newdata = ames, predict.all = TRUE)$individual
```

```{r}
ames$price_pred <- obj[,3]
qplot(overall_qual, year_built, data = ames, color = price_pred) +
  viridis::scale_color_viridis()
```

```{r}
ames$price_pred <- predict(model, newdata = ames)
qplot(overall_qual, year_built, data = ames, color = price_pred) +
  viridis::scale_color_viridis()
```

```{r}
sqrt(tapply((ames$saleprice - ames$price_pred)^2, ames$train_id, mean))
```

```{r}
importance(model)
```


```{r}
sqrt(tapply((ames$saleprice - ames$price_pred)^2, ames$train_id, mean))
```

## Gradient Boosted Trees

```{r}
X <- model.matrix(~ . -1 , data = ames[,-c(1:3)])
y <- ames$saleprice

y_train <- y[ames$train_id == "train"]
y_valid <- y[ames$train_id == "valid"]
X_train <- X[ames$train_id == "train",]
X_valid <- X[ames$train_id == "valid",]
```

```{r, warning = FALSE, message = FALSE}
library(xgboost)
model <- xgboost(data = X_train, label = y_train,
                 max_depth = 2, eta = 0.01, nthread = 2,
                 nrounds = 10, objective = "reg:linear",
                 verbose = 1)
```

```{r, warning = FALSE}
y_valid_pred <- predict(model, newdata = X_valid)
sqrt(mean((y_valid - y_valid_pred)^2))
```

```{r}
data_train <- xgb.DMatrix(data = X_train, label = y_train)
data_valid <- xgb.DMatrix(data = X_valid, label = y_valid)
```

```{r}
watchlist <- list(train=data_train, valid=data_valid)

model <- xgb.train(data = data_train,
                 max_depth = 3, eta = 1, nthread = 2,
                 nrounds = 100, objective = "reg:linear",
                 watchlist = watchlist)
```

```{r}
importance_matrix <- xgb.importance(model = model)
importance_matrix[,1] <- colnames(X)[as.numeric(importance_matrix[[1]]) + 1]
importance_matrix
```





